---
title: 树莓派自动更新动态的IPv6地址到域名解析
tags:
  - 树莓派
  - raspberrypi
  - DDNS
  - IPv6
  - cloudflare
date: 2021-11-15 17:53:48
updated: 2021-11-15 17:53:48
---

近日生出一个想法，国内 IPv6 已经趋于成熟，那么现在可以外网访问到家里的设备吗？

> 当然，这里不是说用内网穿透的方式，而是使用 IPv6 地址

带着这个问题，我查阅了文档。

1. [移动宽带如何获取 IPv6](https://zhuanlan.zhihu.com/p/146528034)
2. [简单好用的 DDNS: ddns-go](https://github.com/jeessy2/ddns-go)

找到角落里落灰的树莓派 3B，来试一试效果吧 :smile_cat:

---

### 1. 让树莓派获得 IPv6 地址

> 如果没有树莓派，可以使用 PC，在 shell 终端里获取 PC 的 IPv6 地址

参照文档 1 设置里路由器，查看路由器里 IPv6 连接信息，ip 相关的开头为 2409 即为配置完成

接下来树莓派连接到路由器，使用 ssh 登录树莓派，这里是

```shell
ssh pi@raspberrypi.local
```

登录到树莓派之后，查询树莓派的 IPv6 地址，返回 2409 开头的即为公网地址

```shell
curl api-ipv6.ip.sb/ip
```

这里返回 2409:8a30:43c:a3a0:9d93:c624:a3c9:becf

### 2.测试 IPv6 地址是否能访问到树莓派

> Mac 用户可以使用 `sudo apachectl start` 开启 80 端口

在树莓派的 80 端口配置静态页，使用浏览器访问 http://raspberrypi.local 之后，用手机浏览器在**使用移动流量的情况下**访问使用上一步的 [2409:8a30:43c:a3a0:9d93:c624:a3c9:becf]，访问到相同的页面。Nice！

**注意！** 务必使用手机，或其他网络的设备测试页面访问，**同个宽带下能访问到相同页面并不能确保此 IPv6 地址的连通性！**

> 1. 若未能访问，**请确认路由器等设备的防火墙全部关闭**
> 2. 访问设备务必支持 IPv6，手机可在接入点查看 APN 协议：_IPv4/IPv6_，本人用的 4G 网络就可以

### 3.把 IPv6 地址配置到域名

使用域名可以更简单快速的访问到设备，在阿里云的域名列表找到一个没用的域名 onlypic.cc

主机记录@，类型 AAAA， 解析值为上文的 IPv6 地址，配置完成后，稍等一会访问，即可访问到树莓派

> 这里配置完之后，使用`ssh pi@onlypic.cc`就可以登录我的树莓派了，所以把树莓派的默认密码就不能再用了 :sweat_smile:

### 4.自动更新 IPv6 地址到域名解析

由于 IPv6 的地址会不时的发生变化，这就意味着使用之前获取的 IPv6 地址，明天就访问不到树莓派了！

这可不符合外网访问的需求！

还好众多的服务商提供了**DDNS**服务，这其中就包括阿里云

参照文档 2，使用 **ddns-go** 来自动更新`onlypic.cc`的解析就大功告成了！

### 5.使用 cloudflare 让树莓派可以用 ipv4 访问！

经过了一番折腾，终于可以使用 IPv6 访问到我们的树莓派了，但是用 ipv4 就不行了！

开头说了，路由器配置了 IPv6，手机目前也实现了 IPv6 的访问，所以我们访问树莓派的时候没什么障碍

但是，如果用户使用了**IPv4**的网络（比如路由器不支持或未设置 IPv6），那么访问就无法直达！用手机 3G 网络就访问不到。

> 手机在 移动网络设置里，网络类型选择 **3G 网络优先**，再次查看第 **3** 步中的页面，页面不行啦！

庆幸的是**cloudflare**可以满足我们的需求，而且 ddns-go 支持 cloudflare，参照文档 2，服务商选择 cloudflare，配置 ddns-go

然后在 cloudflare 配置站点的 DNS，在记录列表里找到 ddns-go 自动配置的域名，启用代理。使用 3G 网络访问，

> 目前移动 3G 已经退网，移动 4G 测试可以访问。所以可以用联通 3G 测试 :smile:
>
> 洪流滚滚向前，希望这一个步骤能被淹没 :runner:

曾经使用**ngrok**、**frp**等内网穿透工具，实现过树莓派的外网访问，

相较而言，这次的方式有如下的优点

1. 省去了公网服务器，不用再买云服务商的带宽啦！
2. 速度大大提升了，摆脱小水管 1M，speed up！:walking: >>> :red_car:
3. 配置简单 (前提是能搞到 IPv6 的地址)
4. 更加安全

**项目地址：http://onlypic.cc**
